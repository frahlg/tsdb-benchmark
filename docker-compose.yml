# TSDB Benchmark Suite for Sourceful Energy
# Target: 10,000 DERs @ 1s interval = 36M datapoints/hour

services:
  # ============================================
  # VictoriaMetrics - Single Node
  # ============================================
  victoriametrics:
    image: victoriametrics/victoria-metrics:v1.106.1
    container_name: victoriametrics
    ports:
      - "8428:8428"
      - "8089:8089"
    volumes:
      - vm-data:/storage
    command:
      - "--storageDataPath=/storage"
      - "--httpListenAddr=:8428"
      - "--influxListenAddr=:8089"
      - "--retentionPeriod=365d"
      - "--memory.allowedPercent=60"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8428/health || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 10s
    restart: unless-stopped

  # ============================================
  # QuestDB
  # ============================================
  questdb:
    image: questdb/questdb:8.2.1
    container_name: questdb
    ports:
      - "9000:9000"
      - "9009:9009"
      - "8812:8812"
    volumes:
      - questdb-data:/var/lib/questdb
    environment:
      - QDB_CAIRO_COMMIT_LAG=1000
      - QDB_LINE_TCP_MAINTENANCE_JOB_INTERVAL=1000
      - QDB_SHARED_WORKER_COUNT=4
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:9000 || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 10s
    restart: unless-stopped

  # ============================================
  # ClickHouse (using full image with curl)
  # ============================================
  clickhouse:
    image: clickhouse/clickhouse-server:24.8
    container_name: clickhouse
    ports:
      - "8123:8123"
      - "9001:9000"
    volumes:
      - clickhouse-data:/var/lib/clickhouse
      - clickhouse-logs:/var/log/clickhouse-server
    environment:
      - CLICKHOUSE_DB=default
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT=1
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    healthcheck:
      test: ["CMD-SHELL", "clickhouse-client --query 'SELECT 1' || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 30s
    restart: unless-stopped

  # ============================================
  # TimescaleDB
  # ============================================
  timescaledb:
    image: timescale/timescaledb:latest-pg16
    container_name: timescaledb
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=sourceful
    volumes:
      - timescale-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 10s
    restart: unless-stopped

  # ============================================
  # Elasticsearch with TSDB mode
  # ============================================
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.17.0
    container_name: elasticsearch
    ports:
      - "9200:9200"
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - xpack.security.enrollment.enabled=false
      - ES_JAVA_OPTS=-Xms1g -Xmx1g
      - cluster.name=tsdb-benchmark
    volumes:
      - elasticsearch-data:/usr/share/elasticsearch/data
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:9200/_cluster/health || exit 1"]
      interval: 5s
      timeout: 10s
      retries: 30
      start_period: 60s
    restart: unless-stopped

  # ============================================
  # InfluxDB2 (TSM engine)
  # ============================================
  influxdb2:
    image: influxdb:2.7
    container_name: influxdb2
    ports:
      - "8086:8086"
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=adminpassword
      - DOCKER_INFLUXDB_INIT_ORG=sourceful
      - DOCKER_INFLUXDB_INIT_BUCKET=energy
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=benchmark-token-secret
    volumes:
      - influxdb2-data:/var/lib/influxdb2
    healthcheck:
      test: ["CMD-SHELL", "influx ping || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 15s
    restart: unless-stopped

  # ============================================
  # InfluxDB3 Core (Apache Arrow-based)
  # ============================================
  influxdb3:
    image: quay.io/influxdb/influxdb3-core:latest
    container_name: influxdb3
    ports:
      - "8181:8181"
    volumes:
      - influxdb3-data:/var/lib/influxdb3
    command:
      - "serve"
      - "--node-id=local01"
      - "--object-store=file"
      - "--data-dir=/var/lib/influxdb3"
      - "--without-auth"
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8181/health || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 15s
    restart: unless-stopped

  # ============================================
  # Grafana - For visualization
  # ============================================
  grafana:
    image: grafana/grafana:11.4.0
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_INSTALL_PLUGINS=grafana-clickhouse-datasource
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana-provisioning:/etc/grafana/provisioning
    depends_on:
      victoriametrics:
        condition: service_healthy
      questdb:
        condition: service_healthy
      clickhouse:
        condition: service_healthy
      timescaledb:
        condition: service_healthy
    restart: unless-stopped

volumes:
  vm-data:
  questdb-data:
  clickhouse-data:
  clickhouse-logs:
  timescale-data:
  elasticsearch-data:
  influxdb2-data:
  influxdb3-data:
  grafana-data:
